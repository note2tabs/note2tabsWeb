generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Account {
  id                 String  @id @default(cuid())
  userId             String
  type               String
  provider           String
  providerAccountId  String
  refresh_token      String?
  access_token       String?
  expires_at         Int?
  token_type         String?
  scope              String?
  id_token           String?
  session_state      String?
  user               User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model User {
  id              String    @id @default(cuid())
  name            String?
  email           String    @unique
  emailVerified   DateTime?
  emailVerifiedBool Boolean @default(false)
  image           String?
  passwordHash    String?
  role            String    @default("FREE")
  tokensRemaining Int       @default(120)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  accounts        Account[]
  sessions        Session[]
  tabs            TabJob[]
  posts           Post[]
}

model TabJob {
  id          String   @id @default(cuid())
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId      String
  sourceType  String
  sourceLabel String?
  durationSec Int?
  resultJson  String
  gteEditorId String?
  createdAt   DateTime @default(now())
}

model AnalyticsEvent {
  id          String   @id @default(cuid())
  userId      String?
  sessionId   String?
  fingerprint String?
  event       String
  path        String?
  referer     String?
  ipHash      String?
  browser     String?
  os          String?
  deviceType  String?
  payload     String?
  createdAt   DateTime @default(now())
}

model UserConsent {
  id            String   @id @default(cuid())
  userId        String?  @unique
  sessionId     String?
  fingerprintId String?
  granted       Boolean
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model AnalyticsEventV2 {
  id              BigInt                   @id @default(autoincrement())
  eventId         String                   @unique
  schemaVersion   Int
  name            String
  legacyEventName String?
  ts              DateTime
  receivedAt      DateTime                 @default(now())
  accountId       String?
  anonId          String?
  sessionId       String?
  fingerprintHash String?
  consentSubjectId BigInt?
  path            String?
  referrer        String?
  utmSource       String?
  utmMedium       String?
  utmCampaign     String?
  utmTerm         String?
  utmContent      String?
  ipHash          String?
  uaBrowser       String?
  uaOs            String?
  uaDevice        String?
  props           Json
  env             String
  appVersion      String?
  consentSubject  AnalyticsConsentSubject? @relation(fields: [consentSubjectId], references: [id], onDelete: SetNull)

  @@index([ts])
  @@index([name, ts])
  @@index([accountId, ts])
  @@index([anonId, ts])
  @@index([fingerprintHash, ts])
  @@index([path, ts])
}

model AnalyticsConsentSubject {
  id              BigInt                 @id @default(autoincrement())
  userId          String?                @unique
  anonId          String?                @unique
  fingerprintHash String?
  state           AnalyticsConsentState  @default(granted)
  createdAt       DateTime               @default(now())
  updatedAt       DateTime               @updatedAt
  audits          AnalyticsConsentAudit[]
  events          AnalyticsEventV2[]

  @@index([fingerprintHash])
}

model AnalyticsConsentAudit {
  id        BigInt                 @id @default(autoincrement())
  subjectId BigInt
  state     AnalyticsConsentState
  source    String?
  metadata  Json?
  changedAt DateTime               @default(now())
  subject   AnalyticsConsentSubject @relation(fields: [subjectId], references: [id], onDelete: Cascade)

  @@index([subjectId, changedAt])
}

model AnalyticsIdentityLink {
  id              BigInt                 @id @default(autoincrement())
  userId          String
  anonId          String?
  fingerprintHash String?
  firstSeenAt     DateTime
  lastSeenAt      DateTime
  expiresAt       DateTime
  source          AnalyticsIdentitySource

  @@unique([userId, fingerprintHash])
  @@unique([userId, anonId])
  @@index([userId])
  @@index([fingerprintHash])
  @@index([anonId])
  @@index([lastSeenAt])
}

model AnalyticsGteSession {
  gteSessionId    String    @id @db.Uuid
  editorId        String
  accountId       String?
  anonId          String?
  fingerprintHash String?
  startedAt       DateTime
  endedAt         DateTime?
  durationMs      Int?
  endReason       String?
  inferredStart   Boolean   @default(false)
  props           Json?
  env             String
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([editorId, startedAt])
  @@index([accountId, startedAt])
  @@index([anonId, startedAt])
  @@index([fingerprintHash, startedAt])
}

model AnalyticsDailyKpi {
  id        BigInt   @id @default(autoincrement())
  day       DateTime
  env       String
  metrics   Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([day, env])
  @@index([day])
}

model Post {
  id             String       @id @default(cuid())
  title          String
  slug           String       @unique
  excerpt        String
  content        String
  contentHtml    String?
  contentToc     Json?
  contentMode    PostContentMode @default(PLAIN)
  coverImageUrl  String?
  status         PostStatus   @default(DRAFT)
  publishAt      DateTime?
  publishedAt    DateTime?
  seoTitle       String?
  seoDescription String?
  canonicalUrl   String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  authorId       String
  author         User         @relation(fields: [authorId], references: [id], onDelete: Cascade)
  categories     PostCategory[]
  tags           PostTag[]
  clusters       PostCluster[]

  @@index([status, publishAt])
}

model Category {
  id          String         @id @default(cuid())
  name        String
  slug        String         @unique
  description String?
  posts       PostCategory[]
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
}

model Tag {
  id        String    @id @default(cuid())
  name      String
  slug      String    @unique
  posts     PostTag[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model TopicCluster {
  id          String        @id @default(cuid())
  name        String
  slug        String        @unique
  description String?
  posts       PostCluster[]
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
}

model PostCategory {
  postId     String
  categoryId String
  post       Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  category   Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@id([postId, categoryId])
  @@index([categoryId])
}

model PostTag {
  postId String
  tagId  String
  post   Post @relation(fields: [postId], references: [id], onDelete: Cascade)
  tag    Tag  @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([postId, tagId])
  @@index([tagId])
}

model PostCluster {
  postId    String
  clusterId String
  isPillar  Boolean @default(false)
  post      Post    @relation(fields: [postId], references: [id], onDelete: Cascade)
  cluster   TopicCluster @relation(fields: [clusterId], references: [id], onDelete: Cascade)

  @@id([postId, clusterId])
  @@index([clusterId])
}

enum PostStatus {
  DRAFT
  SCHEDULED
  PUBLISHED
}

enum PostContentMode {
  PLAIN
  LATEX
}

enum AnalyticsConsentState {
  granted
  denied
}

enum AnalyticsIdentitySource {
  signup
  login
}
